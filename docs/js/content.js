let originalText="",currentInput=null,savedInputSelection=null,savedTextSelection=null,undoStack=[];function handleInputEvent(t){"INPUT"===t.target.tagName||"TEXTAREA"===t.target.tagName||"SELECT"===t.target.tagName?(currentInput=t.target,console.log("1",currentInput)):(currentInput=null,console.log("2",currentInput))}function applyTranslation(t){if(currentInput){savedInputSelection={start:currentInput.selectionStart,end:currentInput.selectionEnd},originalText=currentInput.value;saveToStack("input",originalText,savedInputSelection,currentInput,null);const e=currentInput.value,n=e.slice(0,savedInputSelection.start)+t+e.slice(savedInputSelection.end);navigator.clipboard.writeText(t),currentInput.value=n,currentInput.setSelectionRange(savedInputSelection.start,savedInputSelection.start+t.length)}else{const e=window.getSelection();if(!e.rangeCount)return;savedTextSelection=e.getRangeAt(0),originalText=savedTextSelection.toString(),saveToStack("text",originalText,null,null,savedTextSelection),navigator.clipboard.writeText(t),savedTextSelection.deleteContents(),savedTextSelection.insertNode(document.createTextNode(t))}}function saveToStack(t,e,n,a,o){undoStack.length>=20&&undoStack.shift(),"input"===t?undoStack.push({type:"input",text:e,range:n,input:a}):"text"===t&&undoStack.push({type:"text",text:e,range:o}),console.log("undoStack",undoStack)}function undoLastAction(){if(undoStack.length>0){const t=undoStack.pop();console.log("lastState.type",t.type),"input"===t.type?(t.input.value=t.text,t.input.setSelectionRange(t.range.start,t.range.end)):"text"===t.type&&(t.range.deleteContents(),t.range.insertNode(document.createTextNode(t.text))),console.log("Undo")}}document.addEventListener("input",handleInputEvent),document.addEventListener("mouseup",(()=>{window.getSelection().toString()||(currentInput=null)})),document.addEventListener("keydown",(async t=>{chrome.storage.sync.get(["onOffSwitchState","lang1st","lang2nd","lang3rd","key1st","key2nd","key3rd","fun1st","fun2nd","fun3rd"],(async function(e){const{onOffSwitchState:n,lang1st:a,lang2nd:o,lang3rd:u,key1st:r,key2nd:c,key3rd:l,fun1st:i,fun2nd:d,fun3rd:s}=e;if(!n)return;const p=window.getSelection().toString(),g=await navigator.clipboard.readText(),S=(e,n,a)=>{t[n||"metaKey"]&&t.key===e&&(t.preventDefault(),t.stopPropagation(),translateSelectedText(p||g,a),console.log("Đã dịch:",p||g))};S(r,i,a),S(c,d,o),S(l,s,u),t.metaKey&&"z"===t.key&&(t.preventDefault(),undoLastAction(t))}))}));